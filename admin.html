<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Tama√±os, Precios y Objetos</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="header">
    <h1>Admin ‚Äî Tama√±os, Precios y Objetos</h1>
  </header>

  <!-- Pesta√±as -->
  <nav class="tabs" role="tablist" aria-label="Pesta√±as admin">
    <button class="tab active" data-tab="precios" role="tab" aria-selected="true">üí≤ Precios</button>
    <button class="tab" data-tab="objetos" role="tab" aria-selected="false">üß© Objetos</button>
  </nav>

  <main style="width:100%;max-width:1100px;margin:0 auto 24px auto;">
    <!-- ====== TAB PRECIOS ====== -->
    <section id="precios" class="seccion" aria-live="polite">
      <p class="hint">
        Edita la tabla. <strong>Paquete</strong> indica si ese tama√±o se vende por paquete (true) o por unidad (false).<br/>
        Al <strong>Guardar</strong> se actualiza en tu navegador y, si autorizas, se <strong>sobrescribe</strong> tu archivo
        <code>data/precios.json</code> usando File System Access API.
      </p>

      <div id="admin-table-wrap"></div>

      <div class="admin-toolbar">
        <button id="add-row" class="btn">Agregar fila</button>
        <button id="save-precios" class="btn btn-buy">Guardar</button>
        <button id="link-precios" class="btn">Vincular precios.json‚Ä¶</button>
        <button id="load-default" class="btn">Cargar defaults</button>
      </div>
    </section>

    <!-- ====== TAB OBJETOS ====== -->
    <section id="objetos" class="seccion hidden" aria-live="polite">
      <h3>Pol√≠ticas por objeto (modelos)</h3>
      <p class="hint">
        Marca por cada vector si permite vender por <strong>unidad</strong> o √∫nicamente por <strong>paquete</strong>.
        Esto afecta la pesta√±a <strong>Compras</strong> en el configurador.
      </p>

      <!-- Controles r√°pidos -->
      <div class="admin-toolbar">
        <button id="pol-marcar-unidad" class="btn">Marcar todo como ‚ÄúPermitir unidad‚Äù</button>
        <button id="pol-marcar-paquete" class="btn">Marcar todo como ‚ÄúSolo paquete‚Äù</button>
      </div>

      <!-- Grid similar a la de Modelos en index -->
      <div id="pol-grid" class="modelos-lista"></div>

      <div class="admin-toolbar">
        <button id="save-pol" class="btn btn-buy">Guardar pol√≠ticas</button>
        <button id="link-pol" class="btn">Vincular politicas_modelos.json‚Ä¶</button>
      </div>

      <small class="hint">
        Se guarda en <code>localStorage</code> y, si vinculas, tambi√©n se sobrescribe <code>data/politicas_modelos.json</code>.
      </small>
    </section>
  </main>

  <script>
    (function(){
      // ====== Tabs ======
      const tabs = document.querySelectorAll('.tab');
      const secPrecios = document.getElementById('precios');
      const secObjetos = document.getElementById('objetos');
      function showTab(id){
        [secPrecios, secObjetos].forEach(s => s.classList.add('hidden'));
        if (id === 'precios') secPrecios.classList.remove('hidden');
        if (id === 'objetos') secObjetos.classList.remove('hidden');
      }
      tabs.forEach(t => t.addEventListener('click', ()=>{
        document.querySelector('.tab.active').classList.remove('active');
        t.classList.add('active');
        showTab(t.dataset.tab);
      }));

      // ====== PRECIOS ======
      const wrap = document.getElementById('admin-table-wrap');
      const addRowBtn = document.getElementById('add-row');
      const saveBtn = document.getElementById('save-precios');
      const linkBtn = document.getElementById('link-precios');
      const loadBtn = document.getElementById('load-default');

      let precios = [];
      let fileHandlePrecios = null;

      async function tryLoadPrecios(){
        try{
          const resp = await fetch('./data/precios.json',{cache:'no-store'});
          if(resp.ok){ precios = await resp.json(); }
          else { const stored = localStorage.getItem('precios'); precios = stored? JSON.parse(stored): []; }
        }catch{
          const stored = localStorage.getItem('precios'); precios = stored? JSON.parse(stored): [];
        }
      }
      function renderPrecios(){
        wrap.innerHTML = '';
        const table = document.createElement('table');
        table.className='admin-table';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Tama√±o</th><th>Precio</th><th>Paquete</th><th>Acciones</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        precios.forEach((r,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td contenteditable="true" data-field="tamano">${r.tama√±o}</td>
            <td contenteditable="true" data-field="precio">${r.precio}</td>
            <td style="text-align:center"><input type="checkbox" data-field="paquete" ${r.paquete?'checked':''}></td>
            <td><button data-i="${i}" class="btn remove-row">Eliminar</button></td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrap.appendChild(table);

        wrap.querySelectorAll('.remove-row').forEach(b=>{
          b.addEventListener('click', ()=>{ const i = Number(b.dataset.i); precios.splice(i,1); renderPrecios(); });
        });
      }
      function loadDefaults(){
        precios = [
          { "tama√±o": "Peque√±o", "precio": 120, "paquete": false },
          { "tama√±o": "Mediano", "precio": 180, "paquete": false },
          { "tama√±o": "Grande",  "precio": 250, "paquete": true  }
        ];
        localStorage.setItem('precios', JSON.stringify(precios));
        renderPrecios();
      }
      addRowBtn.addEventListener('click', ()=> {
        precios.push({tama√±o:'Nuevo', precio:0, paquete:false}); renderPrecios();
      });

      async function requestHandlePrecios(){
        try{
          const [handle] = await window.showOpenFilePicker({
            multiple: false,
            types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
            excludeAcceptAllOption: true
          });
          fileHandlePrecios = handle;
          alert('precios.json vinculado. Al guardar se sobrescribir√° ese archivo.');
        }catch(e){}
      }
      async function writeJSON(handle, jsonStr){
        const writable = await handle.createWritable();
        await writable.write(jsonStr);
        await writable.close();
      }
      saveBtn.addEventListener('click', async ()=> {
        const rows = wrap.querySelectorAll('tbody tr');
        const out = [];
        rows.forEach(tr=>{
          const tam = tr.querySelector('[data-field="tamano"]').textContent.trim();
          const pr  = Number(tr.querySelector('[data-field="precio"]').textContent.trim()) || 0;
          const pk  = tr.querySelector('[data-field="paquete"]').checked;
          out.push({tama√±o: tam, precio: pr, paquete: pk});
        });
        precios = out;
        localStorage.setItem('precios', JSON.stringify(out));

        try{
          if (!fileHandlePrecios) await requestHandlePrecios();
          if (fileHandlePrecios){
            await writeJSON(fileHandlePrecios, JSON.stringify(out, null, 2));
            alert('Precios guardados y JSON sobrescrito ‚úî');
          } else {
            alert('Precios guardados en el navegador. Vincula precios.json para sobrescribir el archivo.');
          }
        }catch(e){
          alert('Se guard√≥ en el navegador, pero no se pudo escribir el archivo.');
        }
      });
      linkBtn.addEventListener('click', requestHandlePrecios);
      loadBtn.addEventListener('click', loadDefaults);

      // ====== OBJETOS (pol√≠ticas por modelo) ======
      const polGrid = document.getElementById('pol-grid');
      const savePolBtn = document.getElementById('save-pol');
      const linkPolBtn = document.getElementById('link-pol');
      const btnMarcarUnidad = document.getElementById('pol-marcar-unidad');
      const btnMarcarPaquete = document.getElementById('pol-marcar-paquete');

      let modelos = [];
      let politicas = {}; // { "archivo.svg": { soloPaquete: true/false } }
      let fileHandlePoliticas = null;

      async function cargarModelos(){
        try{
          const r = await fetch('./vectores/');
          const html = await r.text();
          const re = /href="([^"]+\.(svg|png|jpg|jpeg|webp))"/gi;
          const arr = [...html.matchAll(re)].map(m => m[1]);
          modelos = arr.map(a => a.split('/').pop());
        }catch{ modelos = []; }
      }
      async function tryLoadPoliticas(){
        try{
          const r = await fetch('./data/politicas_modelos.json',{cache:'no-store'});
          if (r.ok){ politicas = await r.json(); }
          else { const stored = localStorage.getItem('politicasModelos'); politicas = stored ? JSON.parse(stored) : {}; }
        }catch{
          const stored = localStorage.getItem('politicasModelos'); politicas = stored ? JSON.parse(stored) : {};
        }
      }
      function renderPoliticas(){
        polGrid.innerHTML = '';
        modelos.forEach(m=>{
          const card = document.createElement('div'); card.className='modelo-item';
          const img = document.createElement('img'); img.src=`vectores/${m}`; img.alt=m;
          if (m.endsWith('.svg')) img.classList.add('svg-thumb');

          const meta = document.createElement('div'); meta.className='meta';
          const nombre = document.createElement('div'); nombre.className='nombre'; nombre.textContent = m;

          const radios = document.createElement('div'); radios.className='qty-row';
          const rUnidad = document.createElement('input'); rUnidad.type='radio'; rUnidad.name=`pol-${m}`; rUnidad.value='unidad';
          const lUnidad = document.createElement('label'); lUnidad.appendChild(rUnidad); lUnidad.appendChild(document.createTextNode(' Permitir unidad'));
          const rPack = document.createElement('input'); rPack.type='radio'; rPack.name=`pol-${m}`; rPack.value='paquete';
          const lPack = document.createElement('label'); lPack.appendChild(rPack); lPack.appendChild(document.createTextNode(' Solo paquete'));

          const actual = politicas[m]?.soloPaquete ? 'paquete' : 'unidad';
          if (actual === 'paquete') rPack.checked = true; else rUnidad.checked = true;

          rUnidad.addEventListener('change', ()=>{ politicas[m] = { soloPaquete: false }; });
          rPack.addEventListener('change', ()=>{ politicas[m] = { soloPaquete: true  }; });

          radios.appendChild(lUnidad); radios.appendChild(lPack);
          meta.appendChild(nombre); meta.appendChild(radios);
          card.appendChild(img); card.appendChild(meta);
          polGrid.appendChild(card);
        });
      }
      async function requestHandlePoliticas(){
        try{
          const [handle] = await window.showOpenFilePicker({
            multiple: false,
            types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
            excludeAcceptAllOption: true
          });
          fileHandlePoliticas = handle;
          alert('politicas_modelos.json vinculado. Al guardar se sobrescribir√° ese archivo.');
        }catch(e){}
      }
      async function writeJSON(handle, jsonStr){
        const writable = await handle.createWritable();
        await writable.write(jsonStr);
        await writable.close();
      }
      savePolBtn.addEventListener('click', async ()=>{
        localStorage.setItem('politicasModelos', JSON.stringify(politicas));
        try{
          if (!fileHandlePoliticas) await requestHandlePoliticas();
          if (fileHandlePoliticas){
            await writeJSON(fileHandlePoliticas, JSON.stringify(politicas, null, 2));
            alert('Pol√≠ticas guardadas y JSON sobrescrito ‚úî');
          } else {
            alert('Pol√≠ticas guardadas en el navegador. Vincula politicas_modelos.json para sobrescribir el archivo.');
          }
        }catch(e){
          alert('Se guard√≥ en el navegador, pero no se pudo escribir politicas_modelos.json.');
        }
      });
      linkPolBtn.addEventListener('click', requestHandlePoliticas);

      // Acciones masivas
      btnMarcarUnidad.addEventListener('click', ()=>{
        modelos.forEach(m => politicas[m] = { soloPaquete: false });
        renderPoliticas();
      });
      btnMarcarPaquete.addEventListener('click', ()=>{
        modelos.forEach(m => politicas[m] = { soloPaquete: true });
        renderPoliticas();
      });

      // ====== INIT ======
      (async ()=>{
        await tryLoadPrecios(); renderPrecios();
        await cargarModelos();
        await tryLoadPoliticas(); renderPoliticas();
        showTab('precios');
      })();
    })();
  </script>
</body>
</html>
