<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Blackink Panel</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .modelos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .modelo-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      text-align: center;
      padding: 10px;
      transition: 0.3s;
    }

    .modelo-item img {
      max-width: 100%;
      max-height: 150px;
      margin: auto;
      display: block;
    }

    .modelo-item:hover { transform: scale(1.03); }

    body[data-theme="dark"] .modelo-item img.svg-thumb {
      filter: invert(1) hue-rotate(180deg);
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .btn {
      cursor: pointer;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      background: var(--panel);
      color: var(--text);
      transition: 0.2s;
    }

    .btn:hover { background: var(--accent); color: #000; }
    .hidden { display: none !important; }
    .hint { color: var(--muted); font-size: 13px; margin: 10px 0; }
    .header-right { position: absolute; top: 10px; right: 15px; }
  </style>
</head>
<body>
  <header class="header">
    <h1>üõ†Ô∏è Panel de Administraci√≥n ‚Äî Blackink</h1>
    <div class="header-right">
      <button id="theme-toggle" class="btn" title="Cambiar tema">üåô</button>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Pesta√±as admin">
    <button class="tab active" data-tab="precios">üí≤ Precios</button>
    <button class="tab" data-tab="politicas">üß© Pol√≠ticas de modelos</button>
    <button class="tab" data-tab="fuentes">üóÇÔ∏è Fuentes y vectores</button>
  </nav>

  <main style="width:100%;max-width:1100px;margin:0 auto 24px auto;">
    <!-- ===== PRECIOS ===== -->
    <section id="precios" class="seccion" aria-live="polite">
      <p class="hint">Administra los tama√±os y precios de venta. ‚ÄúPaquete‚Äù indica si ese tama√±o se vende en conjunto.</p>
      <div id="admin-table-wrap"></div>
      <div class="toolbar">
        <button id="add-row" class="btn">Agregar fila</button>
        <button id="save-precios" class="btn">Guardar</button>
        <button id="link-precios" class="btn">Vincular precios.json‚Ä¶</button>
        <button id="load-default" class="btn">Cargar default</button>
      </div>
    </section>

    <!-- ===== POL√çTICAS ===== -->
    <section id="politicas" class="seccion hidden" aria-live="polite">
      <h3>Pol√≠ticas de venta por modelo</h3>
      <p class="hint">Define si un modelo puede venderse por unidad o solo por paquete.</p>

      <div class="toolbar">
        <button id="load-index-modelos" class="btn">üì¶ Cargar todos los modelos (GitHub)</button>
        <button id="pol-marcar-unidad" class="btn">Permitir unidad a todos</button>
        <button id="pol-marcar-paquete" class="btn">Solo paquete a todos</button>
      </div>

      <div id="pol-grid" class="modelos-grid"></div>

      <div class="toolbar">
        <button id="save-pol" class="btn">Guardar pol√≠ticas</button>
        <button id="link-pol" class="btn">Vincular politicas_modelos.json‚Ä¶</button>
      </div>
    </section>

    <!-- ===== FUENTES Y VECTORES ===== -->
    <section id="fuentes" class="seccion hidden" aria-live="polite">
      <h3>Fuentes y Vectores ‚Äî index.json</h3>
      <p class="hint">Detecta autom√°ticamente las fuentes y vectores desde las carpetas locales y permite guardar el index.json en la ra√≠z.</p>

      <div class="toolbar">
        <button id="generateIndexBtn" class="btn">üíæ Generar index.json</button>
      </div>

      <div id="statusFuentes" class="hint">Fuentes detectadas: 0</div>
      <div id="statusVectores" class="hint">Vectores detectados: 0</div>
    </section>
  </main>

  <script>
  (function(){
    /* ========= THEME SYSTEM ========= */
    const body = document.body;
    const themeBtn = document.getElementById('theme-toggle');
    function applyTheme(theme){
      body.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    themeBtn.addEventListener('click', ()=> {
      const newTheme = body.dataset.theme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
    });

    /* ========= TABS ========= */
    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('.seccion');
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        document.querySelector('.tab.active')?.classList.remove('active');
        t.classList.add('active');
        sections.forEach(s=>s.classList.add('hidden'));
        document.getElementById(t.dataset.tab).classList.remove('hidden');
      });
    });

    /* ========= PRECIOS ========= */
    const wrap = document.getElementById('admin-table-wrap');
    const addRowBtn = document.getElementById('add-row');
    const saveBtn = document.getElementById('save-precios');
    const linkBtn = document.getElementById('link-precios');
    const loadBtn = document.getElementById('load-default');
    let precios = [];
    let fileHandlePrecios = null;

    async function tryLoadPrecios(){
      try{
        const resp = await fetch('./data/precios.json',{cache:'no-store'});
        if(resp.ok){ precios = await resp.json(); }
      }catch{ precios=[]; }
      renderPrecios();
    }

    function renderPrecios(){
      wrap.innerHTML='';
      const table=document.createElement('table');
      table.className='admin-table';
      table.innerHTML='<thead><tr><th>Tama√±o</th><th>Precio</th><th>Paquete</th><th>Acci√≥n</th></tr></thead>';
      const tbody=document.createElement('tbody');
      precios.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td contenteditable data-field="tamano">${r.tama√±o}</td>
          <td contenteditable data-field="precio">${r.precio}</td>
          <td style="text-align:center"><input type="checkbox" data-field="paquete" ${r.paquete?'checked':''}></td>
          <td><button class="btn del" data-i="${i}">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      wrap.querySelectorAll('.del').forEach(b=>{
        b.onclick=()=>{precios.splice(b.dataset.i,1);renderPrecios();};
      });
    }

    addRowBtn.onclick=()=>{precios.push({tama√±o:'Nuevo',precio:0,paquete:false});renderPrecios();};
    loadBtn.onclick=()=>{precios=[{tama√±o:'Peque√±o',precio:100,paquete:false}];renderPrecios();};

    async function requestHandlePrecios(){
      try{
        const [h]=await window.showOpenFilePicker({types:[{accept:{'application/json':['.json']}}]});
        fileHandlePrecios=h;
        alert('Archivo precios.json vinculado');
      }catch{}
    }

    saveBtn.onclick=async()=>{
      const rows=wrap.querySelectorAll('tbody tr');
      precios=[...rows].map(tr=>({
        tama√±o:tr.querySelector('[data-field="tamano"]').textContent.trim(),
        precio:Number(tr.querySelector('[data-field="precio"]').textContent.trim())||0,
        paquete:tr.querySelector('[data-field="paquete"]').checked
      }));
      localStorage.setItem('precios',JSON.stringify(precios));
      if(!fileHandlePrecios) await requestHandlePrecios();
      if(fileHandlePrecios){
        const w=await fileHandlePrecios.createWritable();
        await w.write(JSON.stringify(precios,null,2));
        await w.close();
        alert('precios.json actualizado');
      }
    };
    linkBtn.onclick=requestHandlePrecios;

    /* ========= POL√çTICAS ========= */
    const polGrid=document.getElementById('pol-grid');
    const btnUnidad=document.getElementById('pol-marcar-unidad');
    const btnPaquete=document.getElementById('pol-marcar-paquete');
    const btnGuardarPol=document.getElementById('save-pol');
    const btnLinkPol=document.getElementById('link-pol');
    const btnCargarIndex=document.getElementById('load-index-modelos');
    let politicas={};
    let modelos=[];
    let fileHandlePoliticas=null;

    async function cargarModelos(){
      try{
        const r=await fetch('./vectores/');
        const html=await r.text();
        const re=/href="([^"]+\.(svg|png|jpg|jpeg|webp))"/gi;
        modelos=[...html.matchAll(re)].map(m=>m[1].split('/').pop());
      }catch{modelos=[];}
    }

    async function cargarModelosDesdeIndex(){
      try{
        const r=await fetch('./index.json',{cache:'no-store'});
        if(!r.ok) return alert('No se encontr√≥ index.json');
        const data=await r.json();
        modelos=data.modelos||[];
        renderPoliticas();
      }catch{alert('Error al leer index.json');}
    }

    async function tryLoadPoliticas(){
      try{
        const r=await fetch('./data/politicas_modelos.json',{cache:'no-store'});
        if(r.ok) politicas=await r.json();
      }catch{politicas={};}
    }

    function renderPoliticas(){
      polGrid.innerHTML='';
      modelos.forEach(m=>{
        const div=document.createElement('div');
        div.className='modelo-item';
        const img=document.createElement('img');
        img.src=`vectores/${m}`;
        img.alt=m;
        if(m.endsWith('.svg')) img.classList.add('svg-thumb');
        const nombre=document.createElement('div');
        nombre.textContent=m;
        const radios=document.createElement('div');
        const r1=document.createElement('input');r1.type='radio';r1.name=m;r1.value='unidad';
        const l1=document.createElement('label');l1.append(' Unidad');
        const r2=document.createElement('input');r2.type='radio';r2.name=m;r2.value='paquete';
        const l2=document.createElement('label');l2.append(' Paquete');
        if(politicas[m]?.soloPaquete){r2.checked=true;}else{r1.checked=true;}
        r1.onchange=()=>politicas[m]={soloPaquete:false};
        r2.onchange=()=>politicas[m]={soloPaquete:true};
        radios.append(r1,l1,r2,l2);
        div.append(img,nombre,radios);
        polGrid.appendChild(div);
      });
    }

    btnUnidad.onclick=()=>{modelos.forEach(m=>politicas[m]={soloPaquete:false});renderPoliticas();};
    btnPaquete.onclick=()=>{modelos.forEach(m=>politicas[m]={soloPaquete:true});renderPoliticas();};
    btnCargarIndex.onclick=cargarModelosDesdeIndex;

    async function requestHandlePol(){
      try{
        const [h]=await window.showOpenFilePicker({types:[{accept:{'application/json':['.json']}}]});
        fileHandlePoliticas=h;alert('politicas_modelos.json vinculado');
      }catch{}
    }

    btnGuardarPol.onclick=async()=>{
      localStorage.setItem('politicasModelos',JSON.stringify(politicas));
      if(!fileHandlePoliticas) await requestHandlePol();
      if(fileHandlePoliticas){
        const w=await fileHandlePoliticas.createWritable();
        await w.write(JSON.stringify(politicas,null,2));
        await w.close();
        alert('politicas_modelos.json actualizado');
      }
    };
    btnLinkPol.onclick=requestHandlePol;

    /* ========= FUENTES Y VECTORES (AUTOM√ÅTICO) ========= */
    const generateIndexBtn = document.getElementById('generateIndexBtn');
    const statusFuentes = document.getElementById('statusFuentes');
    const statusVectores = document.getElementById('statusVectores');

    let fuentesList = [];
    let vectoresList = [];

    async function detectarArchivosLocales() {
      try {
        const fuentesResp = await fetch('./fuentes/');
        const fuentesHTML = await fuentesResp.text();
        const fuentes = [...fuentesHTML.matchAll(/href="([^"]+\.(ttf|otf|woff2?))"/gi)]
          .map(m => 'fuentes/' + m[1].split('/').pop());
        fuentesList = fuentes;

        const vectoresResp = await fetch('./vectores/');
        const vectoresHTML = await vectoresResp.text();
        const vectores = [...vectoresHTML.matchAll(/href="([^"]+\.(svg|png|jpg|jpeg|webp))"/gi)]
          .map(m => 'vectores/' + m[1].split('/').pop());
        vectoresList = vectores;

        statusFuentes.textContent = `Fuentes detectadas: ${fuentesList.length}`;
        statusVectores.textContent = `Vectores detectados: ${vectoresList.length}`;

        alert('‚úÖ Carpetas detectadas correctamente');
      } catch (err) {
        console.error(err);
        alert('‚ö†Ô∏è No se pudieron leer las carpetas locales.');
      }
    }

    document.querySelector('[data-tab="fuentes"]').addEventListener('click', detectarArchivosLocales);

    generateIndexBtn.onclick = async () => {
      try {
        if (!fuentesList.length && !vectoresList.length) await detectarArchivosLocales();
        const data = { fuentes: fuentesList, modelos: vectoresList };
        const handle = await window.showSaveFilePicker({
          suggestedName: 'index.json',
          types: [{ description: 'Archivo JSON', accept: { 'application/json': ['.json'] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(JSON.stringify(data, null, 2));
        await writable.close();
        alert('‚úÖ index.json generado correctamente con rutas completas');
      } catch (err) {
        console.error(err);
        alert('‚ö†Ô∏è Error al generar el index.json');
      }
    };

    (async()=>{await tryLoadPrecios();await cargarModelos();await tryLoadPoliticas();renderPoliticas();})();
  })();
  </script>
</body>
</html>
